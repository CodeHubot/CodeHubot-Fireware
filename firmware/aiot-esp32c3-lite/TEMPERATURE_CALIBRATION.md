# DHT11 温度校准指南

## 问题分析

根据实际测试日志，发现 DHT11 传感器存在严重的温度偏差问题：

| 状态 | 传感器读数 | 实际温度 | 偏差 |
|------|-----------|---------|------|
| 开机时（WiFi 关闭） | 24.6°C | ~24°C | 正常 ✅ |
| WiFi 连接后 | 49.2°C | ~24°C | +24.6°C ❌ |

**结论**：DHT11 传感器靠近 ESP32 芯片和 WiFi 模块，受热影响严重。

## 温度补偿方案

### 当前实现

代码中已添加自动温度补偿（`main.c` 第 869 行）：

```c
const float TEMP_COMPENSATION = 24.0f;  // 温度补偿值
float compensated_temp = temp - TEMP_COMPENSATION;
```

### 如何调整补偿值

#### 步骤 1：测量实际温度

使用温度计或其他准确的温度传感器测量环境温度，例如：
- 实际温度：**24°C**

#### 步骤 2：查看传感器原始读数

从日志中查看 DHT11 原始读数（WiFi 连接后）：
```
DHT11: 原始温度=49.2°C
```

#### 步骤 3：计算补偿值

```
补偿值 = 传感器读数 - 实际温度
补偿值 = 49.2 - 24.0 = 25.2°C
```

#### 步骤 4：更新代码

修改 `main.c` 中的 `TEMP_COMPENSATION` 值：

```c
const float TEMP_COMPENSATION = 25.2f;  // 根据实际测试调整
```

#### 步骤 5：重新编译并测试

```bash
cd firmware/aiot-esp32c3-lite
idf.py build flash monitor
```

## 预期效果

更新补偿值后，日志输出应该类似：

```
I (xxxx) DHT11: 📊 原始数据: [0x30][0x0C][0x44][0x10][0x91]
I (xxxx) DHT11: 📊 十进制: 湿度=68.16, 温度=48.12, 校验=145
I (xxxx) DHT11: ✅ 温度: 49.2°C, 湿度: 69.6%
I (xxxx) MAIN: DHT11: 原始温度=49.2°C, 补偿后=24.0°C, 湿度=69.6%
W (xxxx) MAIN: ⚠️  传感器读数偏高(49.2°C)，已自动补偿为24.0°C
W (xxxx) MAIN: 💡 建议：将DHT11传感器远离ESP32芯片和WiFi模块
```

## 注意事项

### 1. 补偿值的局限性

- **补偿值是固定的**：实际环境温度变化时，偏差也会变化
- **不同环境不同偏差**：室内/室外、夏季/冬季的偏差可能不同
- **湿度也会受影响**：高温环境下湿度读数也可能不准确

### 2. 更好的解决方案

#### 硬件改进（强烈推荐）

**方案 A：使用延长线**
```
ESP32 芯片 ←→ 5-10cm 延长线 ←→ DHT11 传感器
```
- 将 DHT11 的 VCC、GND、DATA 引脚用杜邦线延长
- 远离芯片和 WiFi 模块
- 添加 4.7K-10K 外部上拉电阻（DATA 到 VCC）

**方案 B：PCB 重新设计**
```
┌─────────────────────┐
│  ESP32 芯片         │
│  (发热源)            │
│                     │
│                     │    DHT11
│                     │◄──────┤ 
│                     │  远端位置
└─────────────────────┘
```
- 将传感器放置在 PCB 边缘
- 远离芯片、WiFi 天线、电源模块
- 考虑添加散热片或通风孔

#### 升级传感器（最佳方案）

| 传感器型号 | 精度 | 价格 | 特点 |
|-----------|------|------|------|
| **DHT11** | ±2°C | 3-5元 | 当前使用，精度低 |
| **DHT22** | ±0.5°C | 10-15元 | 兼容DHT11，精度高 |
| **SHT30** | ±0.2°C | 15-20元 | I2C接口，精度最高 |
| **AHT20** | ±0.3°C | 8-12元 | I2C接口，性价比高 |

**推荐**：升级到 **DHT22** 或 **AHT20**
- DHT22：与 DHT11 代码基本兼容，只需调整数据解析
- AHT20：性价比最高，但需要修改代码为 I2C 通信

## 多环境校准

如果需要在不同环境下使用，可以考虑**动态补偿**：

### 方法 1：基于开机温度的动态补偿

```c
// 全局变量
static float g_baseline_temp = 0.0f;
static bool g_baseline_set = false;

// 在 WiFi 连接前（开机时）读取基准温度
if (!g_baseline_set && !g_wifi_connected) {
    dht11_data_t baseline_data;
    if (dht11_read(&baseline_data) == ESP_OK) {
        g_baseline_temp = baseline_data.temperature;
        g_baseline_set = true;
        ESP_LOGI(TAG, "基准温度: %.1f°C", g_baseline_temp);
    }
}

// WiFi 连接后使用动态补偿
if (g_wifi_connected && g_baseline_set) {
    float temp_offset = temp - g_baseline_temp;
    float compensated_temp = g_baseline_temp;  // 假设实际温度不变
    ESP_LOGI(TAG, "动态补偿: 基准=%.1f°C, 当前读数=%.1f°C, 补偿为=%.1f°C",
             g_baseline_temp, temp, compensated_temp);
}
```

### 方法 2：分段补偿

根据传感器读数区间使用不同的补偿值：

```c
float get_temp_compensation(float raw_temp) {
    if (raw_temp < 30.0f) {
        return 5.0f;   // 低温补偿
    } else if (raw_temp < 40.0f) {
        return 15.0f;  // 中温补偿
    } else {
        return 25.0f;  // 高温补偿
    }
}

float compensated_temp = temp - get_temp_compensation(temp);
```

## 验证补偿效果

### 测试步骤

1. **准备参考温度计**：数字温度计或手机温度 App
2. **同时记录数据**：
   - 参考温度计读数
   - DHT11 原始读数
   - DHT11 补偿后读数
3. **多次测量**：在不同时间、不同环境下测试
4. **计算误差**：

```
平均误差 = Σ(补偿后温度 - 实际温度) / 测试次数
```

### 期望结果

- **理想**：平均误差 < ±2°C
- **可接受**：平均误差 < ±3°C
- **需要改进**：平均误差 > ±3°C

如果补偿后误差仍然很大，建议：
1. 检查硬件连接
2. 更换传感器
3. 考虑升级到更高精度的传感器

## 常见问题

### Q1: 为什么不同时间补偿效果不同？

A: 因为：
- 环境温度在变化（早晚温差、空调等）
- WiFi 负载不同（数据传输越多，发热越大）
- 芯片工作负载不同

**解决**：使用动态补偿或多次测量取平均值。

### Q2: 补偿后温度仍然不准怎么办？

A: 检查以下几点：
1. 补偿值是否正确计算
2. 参考温度计是否准确
3. 传感器是否损坏或假冒
4. 是否受到其他热源影响（阳光直射、空调出风口等）

### Q3: 湿度读数也不准怎么办？

A: 湿度读数受温度影响：
- 高温环境下，湿度测量误差更大
- DHT11 湿度精度本身就较低（±5%）
- 建议升级到 DHT22（±2%）或 SHT30（±2%）

### Q4: 可以不补偿，直接使用原始值吗？

A: 可以，但需要告知用户：
```c
// 不使用补偿，直接输出原始值
ESP_LOGI(TAG, "DHT11 传感器温度: %.1f°C (注意：受芯片发热影响，可能偏高)", temp);
```

用户需要知道这个温度是**传感器位置的温度**，而不是**环境温度**。

## 总结

| 方案 | 成本 | 难度 | 效果 | 推荐指数 |
|------|------|------|------|----------|
| 软件补偿（固定值） | 免费 | 简单 | 中等 | ⭐⭐⭐ |
| 软件补偿（动态） | 免费 | 中等 | 较好 | ⭐⭐⭐⭐ |
| 延长线改造 | 1-2元 | 简单 | 好 | ⭐⭐⭐⭐⭐ |
| PCB 重新设计 | 50-100元 | 困难 | 最好 | ⭐⭐⭐⭐⭐ |
| 升级到 DHT22 | 10-15元 | 简单 | 最好 | ⭐⭐⭐⭐⭐ |
| 升级到 AHT20 | 8-12元 | 中等 | 最好 | ⭐⭐⭐⭐⭐ |

**综合建议**：
1. **短期**：使用软件补偿（已在代码中实现）
2. **中期**：使用延长线将传感器远离芯片
3. **长期**：升级到 DHT22 或 AHT20

---

**最后更新**: 2026-01-02

