# ğŸš€ OTAå›ºä»¶æ›´æ–°å®Œæ•´å®ç°æ–¹æ¡ˆ

## ğŸ“‹ ç°çŠ¶åˆ†æ

### âœ… å·²æœ‰åŸºç¡€

1. **åç«¯API** (`backend/app/api/firmware.py`)
   - âœ… å›ºä»¶ä¸Šä¼ æ¥å£ `/api/firmware/upload`
   - âœ… å›ºä»¶æ£€æŸ¥æ¥å£ `/api/firmware/check`
   - âœ… å›ºä»¶åˆ—è¡¨/æŸ¥è¯¢/æ›´æ–°/åˆ é™¤æ¥å£
   - âœ… ç‰ˆæœ¬å·å¯¹æ¯”é€»è¾‘

2. **å›ºä»¶ç«¯OTAç®¡ç†å™¨** (`firmware/aiot-esp32/main/ota/`)
   - âœ… `ota_manager.c` - OTAæ ¸å¿ƒå®ç°
   - âœ… `ota_manager.h` - OTAæ¥å£å®šä¹‰
   - âœ… ç‰ˆæœ¬æ£€æŸ¥ã€æµå¼ä¸‹è½½ã€è¿›åº¦å›è°ƒ
   - âœ… å›ºä»¶éªŒè¯ã€è‡ªåŠ¨å›æ»šæœºåˆ¶

3. **é…ç½®æœåŠ¡** (`provisioning-service/main.py`)
   - âœ… `/device/info` æ¥å£è¿”å›å›ºä»¶æ›´æ–°ä¿¡æ¯
   - âœ… å›ºä»¶ç‰ˆæœ¬æ•°æ®åº“è¡¨ `firmware_versions`

4. **é™æ€æ–‡ä»¶æœåŠ¡** (`backend/main.py`)
   - âœ… `/static` ç›®å½•å·²æŒ‚è½½
   - âš ï¸ å›ºä»¶URLéœ€è¦ä¿®å¤ï¼ˆå½“å‰æ˜¯localhostï¼‰

### âŒ éœ€è¦å®Œå–„çš„éƒ¨åˆ†

1. **åç«¯**
   - âŒ å›ºä»¶URLéœ€è¦åŠ¨æ€ç”Ÿæˆï¼ˆä½¿ç”¨å®é™…æœåŠ¡å™¨åœ°å€ï¼‰
   - âŒ éœ€è¦é…ç½®ç¯å¢ƒå˜é‡æ”¯æŒä¸åŒç¯å¢ƒ
   - âŒ å›ºä»¶æ–‡ä»¶ä¸‹è½½æœåŠ¡ä¼˜åŒ–ï¼ˆæ”¯æŒæ–­ç‚¹ç»­ä¼ ï¼‰

2. **å‰ç«¯**
   - âŒ OTAç®¡ç†é¡µé¢ï¼ˆå›ºä»¶ä¸Šä¼ ã€åˆ—è¡¨ã€ç‰ˆæœ¬ç®¡ç†ï¼‰
   - âŒ è®¾å¤‡OTAæ›´æ–°è§¦å‘ç•Œé¢
   - âŒ OTAæ›´æ–°çŠ¶æ€ç›‘æ§

3. **å›ºä»¶ç«¯**
   - âŒ é›†æˆOTAæ£€æŸ¥åˆ°ä¸»å¯åŠ¨æµç¨‹
   - âŒ OTAæ›´æ–°ç­–ç•¥ï¼ˆç«‹å³/å®šæ—¶/æ‰‹åŠ¨ï¼‰
   - âŒ LCDæ˜¾ç¤ºOTAè¿›åº¦

4. **é…ç½®æœåŠ¡**
   - âŒ ç¡®ä¿å›ºä»¶URLæ­£ç¡®è¿”å›ç»™è®¾å¤‡

---

## ğŸ¯ å®ç°æ–¹æ¡ˆ

### é˜¶æ®µ1: åç«¯å®Œå–„ï¼ˆä¼˜å…ˆçº§ï¼šé«˜ï¼‰

#### 1.1 ä¿®å¤å›ºä»¶URLç”Ÿæˆ

**é—®é¢˜**: å½“å‰å›ºä»¶URLç¡¬ç¼–ç ä¸º `http://localhost:8000`

**è§£å†³æ–¹æ¡ˆ**:

```python
# backend/app/core/config.py
class Settings:
    # æ·»åŠ æœåŠ¡å™¨åŸºç¡€URLé…ç½®
    SERVER_BASE_URL: str = os.getenv("SERVER_BASE_URL", "http://localhost:8000")
    FIRMWARE_BASE_URL: str = os.getenv("FIRMWARE_BASE_URL", SERVER_BASE_URL)

# backend/app/api/firmware.py
from app.core.config import settings

# ä¿®æ”¹ä¸Šä¼ æ¥å£
firmware_url = f"{settings.FIRMWARE_BASE_URL}/static/firmware/{filename}"
```

**ç¯å¢ƒå˜é‡é…ç½®**:
```bash
# å¼€å‘ç¯å¢ƒ
SERVER_BASE_URL=http://localhost:8000

# ç”Ÿäº§ç¯å¢ƒ
SERVER_BASE_URL=https://demo.example.com:8000
FIRMWARE_BASE_URL=https://cdn.example.com  # å¯é€‰ï¼šä½¿ç”¨CDN
```

#### 1.2 ä¼˜åŒ–å›ºä»¶ä¸‹è½½æœåŠ¡

**æ·»åŠ æ–­ç‚¹ç»­ä¼ æ”¯æŒ**ï¼ˆå¯é€‰ï¼Œä½†æ¨èï¼‰:

```python
# backend/app/api/firmware.py
@router.get("/download/{firmware_id}")
async def download_firmware(
    firmware_id: int,
    request: Request,
    db: Session = Depends(get_db)
):
    """æ”¯æŒæ–­ç‚¹ç»­ä¼ çš„å›ºä»¶ä¸‹è½½"""
    firmware = db.query(Firmware).filter(Firmware.id == firmware_id).first()
    if not firmware:
        raise HTTPException(404, "å›ºä»¶ä¸å­˜åœ¨")
    
    file_path = firmware.firmware_url.replace(settings.FIRMWARE_BASE_URL, "static")
    # å®ç°Rangeè¯·æ±‚æ”¯æŒ...
```

#### 1.3 æ·»åŠ OTAè§¦å‘æ¥å£

**å…è®¸ç®¡ç†å‘˜æ‰‹åŠ¨è§¦å‘è®¾å¤‡OTAæ›´æ–°**:

```python
# backend/app/api/devices.py
@router.post("/{device_uuid}/ota/trigger")
async def trigger_ota_update(
    device_uuid: str,
    db: Session = Depends(get_db),
    current_user: User = Depends(get_current_user)
):
    """é€šè¿‡MQTTè§¦å‘è®¾å¤‡OTAæ›´æ–°"""
    # 1. æ£€æŸ¥è®¾å¤‡æ˜¯å¦å­˜åœ¨
    # 2. è·å–æœ€æ–°å›ºä»¶ç‰ˆæœ¬
    # 3. é€šè¿‡MQTTå‘é€OTAè§¦å‘å‘½ä»¤
    # 4. è®°å½•OTAè§¦å‘æ—¥å¿—
```

---

### é˜¶æ®µ2: å‰ç«¯å®ç°ï¼ˆä¼˜å…ˆçº§ï¼šé«˜ï¼‰

#### 2.1 OTAç®¡ç†é¡µé¢

**æ–‡ä»¶**: `frontend/src/views/FirmwareManagement.vue`

**åŠŸèƒ½**:
- âœ… å›ºä»¶åˆ—è¡¨ï¼ˆæŒ‰äº§å“ç­›é€‰ï¼‰
- âœ… å›ºä»¶ä¸Šä¼ ï¼ˆæ‹–æ‹½ä¸Šä¼ ï¼‰
- âœ… ç‰ˆæœ¬ç®¡ç†ï¼ˆè®¾ç½®æœ€æ–°ç‰ˆæœ¬ã€æ¿€æ´»/ç¦ç”¨ï¼‰
- âœ… å›ºä»¶åˆ é™¤
- âœ… ç‰ˆæœ¬å¯¹æ¯”ï¼ˆå½“å‰ç‰ˆæœ¬ vs æœ€æ–°ç‰ˆæœ¬ï¼‰

**ç•Œé¢è®¾è®¡**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  OTAå›ºä»¶ç®¡ç†                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [ä¸Šä¼ å›ºä»¶] [åˆ·æ–°]                               â”‚
â”‚                                                  â”‚
â”‚  äº§å“ç­›é€‰: [å…¨éƒ¨ â–¼]                              â”‚
â”‚                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ESP32-S3-Dev-01  v1.5.0  [æœ€æ–°] [æ¿€æ´»]   â”‚  â”‚
â”‚  â”‚ å¤§å°: 2.5MB | ä¸Šä¼ æ—¶é—´: 2025-11-20       â”‚  â”‚
â”‚  â”‚ æè¿°: ä¿®å¤MQTTè¿æ¥é—®é¢˜                    â”‚  â”‚
â”‚  â”‚ [è¯¦æƒ…] [ä¸‹è½½] [åˆ é™¤]                      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ESP32-S3-Dev-01  v1.4.0  [è®¾ä¸ºæœ€æ–°]     â”‚  â”‚
â”‚  â”‚ å¤§å°: 2.4MB | ä¸Šä¼ æ—¶é—´: 2025-11-15       â”‚  â”‚
â”‚  â”‚ æè¿°: åˆå§‹ç‰ˆæœ¬                             â”‚  â”‚
â”‚  â”‚ [è¯¦æƒ…] [ä¸‹è½½] [åˆ é™¤]                      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 2.2 è®¾å¤‡OTAæ›´æ–°ç•Œé¢

**æ–‡ä»¶**: `frontend/src/views/DeviceOTA.vue` æˆ–é›†æˆåˆ° `DeviceDetail.vue`

**åŠŸèƒ½**:
- âœ… æ˜¾ç¤ºè®¾å¤‡å½“å‰å›ºä»¶ç‰ˆæœ¬
- âœ… æ˜¾ç¤ºæœ€æ–°å¯ç”¨ç‰ˆæœ¬
- âœ… æ‰‹åŠ¨è§¦å‘OTAæ›´æ–°
- âœ… OTAæ›´æ–°çŠ¶æ€ç›‘æ§ï¼ˆä¸‹è½½ä¸­ã€å®‰è£…ä¸­ã€å®Œæˆï¼‰
- âœ… OTAæ›´æ–°å†å²è®°å½•

**ç•Œé¢è®¾è®¡**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è®¾å¤‡OTAæ›´æ–° - å¼€å‘æµ‹è¯•                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  å½“å‰ç‰ˆæœ¬: v1.4.0                               â”‚
â”‚  æœ€æ–°ç‰ˆæœ¬: v1.5.0  [æœ‰æ–°ç‰ˆæœ¬]                   â”‚
â”‚                                                  â”‚
â”‚  æ›´æ–°å†…å®¹:                                       â”‚
â”‚  â€¢ ä¿®å¤MQTTè¿æ¥é—®é¢˜                              â”‚
â”‚  â€¢ ä¼˜åŒ–ä¼ æ„Ÿå™¨æ•°æ®é‡‡é›†                            â”‚
â”‚  â€¢ æå‡ç³»ç»Ÿç¨³å®šæ€§                                â”‚
â”‚                                                  â”‚
â”‚  [ç«‹å³æ›´æ–°] [ç¨åæé†’]                           â”‚
â”‚                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ OTAæ›´æ–°å†å²                                â”‚  â”‚
â”‚  â”‚ 2025-11-20 10:30  v1.4.0 â†’ v1.5.0  âœ…    â”‚  â”‚
â”‚  â”‚ 2025-11-15 14:20  v1.3.0 â†’ v1.4.0  âœ…    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 2.3 APIæœåŠ¡

**æ–‡ä»¶**: `frontend/src/api/firmware.js`

```javascript
// å›ºä»¶ç®¡ç†API
export const firmwareAPI = {
  // è·å–å›ºä»¶åˆ—è¡¨
  getFirmwareList(params) {
    return request.get('/api/firmware', { params })
  },
  
  // ä¸Šä¼ å›ºä»¶
  uploadFirmware(formData) {
    return request.post('/api/firmware/upload', formData, {
      headers: { 'Content-Type': 'multipart/form-data' }
    })
  },
  
  // è§¦å‘è®¾å¤‡OTAæ›´æ–°
  triggerOTA(deviceUuid) {
    return request.post(`/api/devices/${deviceUuid}/ota/trigger`)
  },
  
  // æ£€æŸ¥è®¾å¤‡OTAçŠ¶æ€
  checkOTAStatus(deviceUuid) {
    return request.get(`/api/devices/${deviceUuid}/ota/status`)
  }
}
```

---

### é˜¶æ®µ3: å›ºä»¶ç«¯é›†æˆï¼ˆä¼˜å…ˆçº§ï¼šä¸­ï¼‰

#### 3.1 é›†æˆOTAæ£€æŸ¥åˆ°ä¸»æµç¨‹

**æ–‡ä»¶**: `firmware/aiot-esp32/main/main.c` æˆ– `startup/startup_manager.c`

```c
void app_main(void) {
    // 1. åŸºç¡€åˆå§‹åŒ–
    ESP_LOGI(TAG, "å›ºä»¶ç‰ˆæœ¬: %s", FIRMWARE_VERSION);
    
    // 2. WiFiè¿æ¥
    wifi_init_sta();
    
    // 3. OTAåˆå§‹åŒ–
    ota_manager_init();
    
    // 4. æ ‡è®°å½“å‰å›ºä»¶æœ‰æ•ˆï¼ˆé˜²æ­¢å›æ»šï¼‰
    ota_manager_mark_valid();
    
    // 5. æ£€æŸ¥OTAæ›´æ–°ï¼ˆå¯é€‰ï¼šå»¶è¿Ÿæ£€æŸ¥ï¼‰
    xTaskCreate(ota_check_task, "ota_check", 4096, NULL, 5, NULL);
    
    // 6. å…¶ä»–åˆå§‹åŒ–...
}

void ota_check_task(void *pvParameters) {
    vTaskDelay(pdMS_TO_TICKS(5000));  // ç­‰å¾…5ç§’ï¼Œç¡®ä¿ç½‘ç»œç¨³å®š
    
    firmware_info_t fw_info;
    esp_err_t ret = ota_manager_check_version(
        CONFIG_PROVISION_SERVER_URL,
        get_mac_address(),
        FIRMWARE_VERSION,
        &fw_info
    );
    
    if (ret == ESP_OK && fw_info.available) {
        ESP_LOGI(TAG, "å‘ç°æ–°ç‰ˆæœ¬: %s", fw_info.version);
        
        // ç­–ç•¥1: ç«‹å³æ›´æ–°ï¼ˆé€‚åˆå¼€å‘æµ‹è¯•ï¼‰
        // ota_manager_start_upgrade(fw_info.download_url, ota_progress_callback);
        
        // ç­–ç•¥2: å®šæ—¶æ›´æ–°ï¼ˆé€‚åˆç”Ÿäº§ç¯å¢ƒï¼‰
        // if (is_update_time()) {
        //     ota_manager_start_upgrade(fw_info.download_url, ota_progress_callback);
        // }
        
        // ç­–ç•¥3: ç­‰å¾…MQTTå‘½ä»¤ï¼ˆæ¨èï¼‰
        // é€šè¿‡MQTTæ¥æ”¶OTAè§¦å‘å‘½ä»¤åæ‰§è¡Œæ›´æ–°
    }
    
    vTaskDelete(NULL);
}
```

#### 3.2 OTAæ›´æ–°ç­–ç•¥

**ç­–ç•¥1: ç«‹å³æ›´æ–°**ï¼ˆå¼€å‘æµ‹è¯•ï¼‰
```c
if (fw_info.available) {
    ESP_LOGI(TAG, "3ç§’åå¼€å§‹æ›´æ–°...");
    vTaskDelay(pdMS_TO_TICKS(3000));
    ota_manager_start_upgrade(fw_info.download_url, callback);
}
```

**ç­–ç•¥2: å®šæ—¶æ›´æ–°**ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
```c
if (fw_info.available && is_update_time()) {
    // å‡Œæ™¨3ç‚¹æ›´æ–°
    ota_manager_start_upgrade(fw_info.download_url, callback);
}
```

**ç­–ç•¥3: MQTTè§¦å‘**ï¼ˆæ¨èï¼‰
```c
// åœ¨MQTTå‘½ä»¤å¤„ç†ä¸­
if (strcmp(cmd, "ota_update") == 0) {
    firmware_info_t fw_info;
    // é‡æ–°æ£€æŸ¥ç‰ˆæœ¬
    ota_manager_check_version(...);
    if (fw_info.available) {
        ota_manager_start_upgrade(fw_info.download_url, callback);
    }
}
```

#### 3.3 LCDæ˜¾ç¤ºOTAè¿›åº¦

**æ–‡ä»¶**: `firmware/aiot-esp32/main/ota/ota_manager.c`

```c
void ota_progress_callback(int progress, size_t speed) {
    ESP_LOGI(TAG, "OTAè¿›åº¦: %d%%, é€Ÿåº¦: %uKB/s", progress, speed/1024);
    
    // æ›´æ–°LCDæ˜¾ç¤º
    #ifdef CONFIG_LCD_ENABLED
    char status[64];
    snprintf(status, sizeof(status), "æ›´æ–°ä¸­ %d%%", progress);
    lcd_display_status(status);
    #endif
}
```

---

### é˜¶æ®µ4: é…ç½®æœåŠ¡å®Œå–„ï¼ˆä¼˜å…ˆçº§ï¼šä½ï¼‰

#### 4.1 ç¡®ä¿å›ºä»¶URLæ­£ç¡®è¿”å›

**æ–‡ä»¶**: `provisioning-service/main.py`

```python
def _get_device_info_impl(...):
    # æŸ¥è¯¢æœ€æ–°å›ºä»¶
    latest_firmware = db.query(FirmwareVersion).filter(...).first()
    
    if latest_firmware:
        # ç¡®ä¿URLæ˜¯å®Œæ•´çš„HTTP(S)åœ°å€
        firmware_url = latest_firmware.firmware_url
        if not firmware_url.startswith('http'):
            firmware_url = f"{settings.BACKEND_BASE_URL}{firmware_url}"
        
        firmware_update = {
            "available": True,
            "version": latest_firmware.version,
            "download_url": firmware_url,  # âœ… å®Œæ•´URL
            "file_size": latest_firmware.file_size,
            "checksum": latest_firmware.file_hash,
            "changelog": latest_firmware.release_notes
        }
```

---

## ğŸ“Š å®ç°ä¼˜å…ˆçº§å’Œæ—¶é—´ä¼°ç®—

| é˜¶æ®µ | ä»»åŠ¡ | ä¼˜å…ˆçº§ | é¢„ä¼°æ—¶é—´ | ä¾èµ– |
|------|------|--------|---------|------|
| **é˜¶æ®µ1** | ä¿®å¤å›ºä»¶URLç”Ÿæˆ | ğŸ”´ é«˜ | 1å°æ—¶ | æ—  |
| **é˜¶æ®µ1** | æ·»åŠ OTAè§¦å‘æ¥å£ | ğŸ”´ é«˜ | 2å°æ—¶ | é˜¶æ®µ1 |
| **é˜¶æ®µ2** | OTAç®¡ç†é¡µé¢ | ğŸ”´ é«˜ | 4å°æ—¶ | é˜¶æ®µ1 |
| **é˜¶æ®µ2** | è®¾å¤‡OTAç•Œé¢ | ğŸŸ¡ ä¸­ | 3å°æ—¶ | é˜¶æ®µ1 |
| **é˜¶æ®µ3** | é›†æˆOTAæ£€æŸ¥ | ğŸŸ¡ ä¸­ | 2å°æ—¶ | é˜¶æ®µ1 |
| **é˜¶æ®µ3** | MQTTè§¦å‘OTA | ğŸŸ¡ ä¸­ | 2å°æ—¶ | é˜¶æ®µ1 |
| **é˜¶æ®µ4** | é…ç½®æœåŠ¡å®Œå–„ | ğŸŸ¢ ä½ | 1å°æ—¶ | é˜¶æ®µ1 |

**æ€»è®¡**: çº¦15å°æ—¶ï¼ˆ2ä¸ªå·¥ä½œæ—¥ï¼‰

---

## ğŸ”„ å®Œæ•´OTAæµç¨‹

### æµç¨‹1: ç®¡ç†å‘˜ä¸Šä¼ å›ºä»¶

```
1. ç®¡ç†å‘˜åœ¨å‰ç«¯ä¸Šä¼ å›ºä»¶æ–‡ä»¶
   â†“
2. åç«¯ä¿å­˜æ–‡ä»¶åˆ° /static/firmware/
   â†“
3. è®¡ç®—SHA256å“ˆå¸Œå€¼
   â†“
4. åˆ›å»ºæ•°æ®åº“è®°å½•ï¼ˆfirmware_versionsè¡¨ï¼‰
   â†“
5. è®¾ç½® is_latest = trueï¼ˆè‡ªåŠ¨å–æ¶ˆå…¶ä»–ç‰ˆæœ¬çš„æœ€æ–°æ ‡è®°ï¼‰
   â†“
6. è¿”å›æˆåŠŸï¼Œå‰ç«¯æ˜¾ç¤ºå›ºä»¶åˆ—è¡¨
```

### æµç¨‹2: è®¾å¤‡æ£€æŸ¥æ›´æ–°

```
1. è®¾å¤‡å¯åŠ¨ï¼ŒWiFiè¿æ¥æˆåŠŸ
   â†“
2. è°ƒç”¨ ota_manager_check_version()
   â†“
3. HTTP GET /device/info?mac=xx&firmware_version=1.4.0
   â†“
4. é…ç½®æœåŠ¡æŸ¥è¯¢æœ€æ–°å›ºä»¶
   â†“
5. æ¯”è¾ƒç‰ˆæœ¬å·ï¼ˆæœåŠ¡å™¨ç«¯ï¼‰
   â†“
6. è¿”å›å›ºä»¶ä¿¡æ¯ï¼ˆå¦‚æœæœ‰æ–°ç‰ˆæœ¬ï¼‰
   â†“
7. è®¾å¤‡åˆ¤æ–­ï¼šæœ‰URL = éœ€è¦æ›´æ–°
```

### æµç¨‹3: è®¾å¤‡æ‰§è¡Œæ›´æ–°

```
1. è®¾å¤‡å‘ç°æ–°ç‰ˆæœ¬
   â†“
2. è°ƒç”¨ ota_manager_start_upgrade(firmware_url, callback)
   â†“
3. HTTP GET ä¸‹è½½å›ºä»¶ï¼ˆæµå¼ä¸‹è½½ï¼‰
   â†“
4. å†™å…¥OTAåˆ†åŒºï¼ˆè¾¹ä¸‹è¾¹å†™ï¼‰
   â†“
5. æ˜¾ç¤ºè¿›åº¦ï¼ˆLCD/ä¸²å£æ—¥å¿—ï¼‰
   â†“
6. ä¸‹è½½å®Œæˆï¼ŒéªŒè¯å›ºä»¶
   â†“
7. è®¾ç½®å¯åŠ¨åˆ†åŒº
   â†“
8. é‡å¯è®¾å¤‡
   â†“
9. æ–°å›ºä»¶å¯åŠ¨ï¼Œæ ‡è®°ä¸ºæœ‰æ•ˆ
```

### æµç¨‹4: ç®¡ç†å‘˜æ‰‹åŠ¨è§¦å‘

```
1. ç®¡ç†å‘˜åœ¨å‰ç«¯ç‚¹å‡»"ç«‹å³æ›´æ–°"
   â†“
2. å‰ç«¯è°ƒç”¨ /api/devices/{uuid}/ota/trigger
   â†“
3. åç«¯é€šè¿‡MQTTå‘é€OTAå‘½ä»¤
   â†“
4. è®¾å¤‡æ¥æ”¶MQTTå‘½ä»¤
   â†“
5. è®¾å¤‡æ‰§è¡Œæµç¨‹3ï¼ˆæ›´æ–°æµç¨‹ï¼‰
```

---

## ğŸ”’ å®‰å…¨è€ƒè™‘

### 1. å›ºä»¶éªŒè¯
- âœ… SHA256æ ¡éªŒå’ŒéªŒè¯
- âœ… ESP-IDFå›ºä»¶å¤´éƒ¨éªŒè¯
- âœ… è‡ªåŠ¨å›æ»šæœºåˆ¶

### 2. ä¼ è¾“å®‰å…¨
- âš ï¸ å»ºè®®ä½¿ç”¨HTTPSï¼ˆéœ€è¦é…ç½®SSLè¯ä¹¦ï¼‰
- âš ï¸ å›ºä»¶URLç­¾åéªŒè¯ï¼ˆå¯é€‰ï¼‰

### 3. è®¿é—®æ§åˆ¶
- âœ… å›ºä»¶ä¸Šä¼ éœ€è¦ç®¡ç†å‘˜æƒé™
- âœ… OTAè§¦å‘éœ€è¦è®¾å¤‡æ‰€æœ‰è€…æƒé™

---

## ğŸ“ æµ‹è¯•æ¸…å•

### åç«¯æµ‹è¯•
- [ ] å›ºä»¶ä¸Šä¼ åŠŸèƒ½
- [ ] å›ºä»¶URLç”Ÿæˆæ­£ç¡®
- [ ] ç‰ˆæœ¬å·å¯¹æ¯”é€»è¾‘
- [ ] OTAè§¦å‘MQTTå‘½ä»¤

### å‰ç«¯æµ‹è¯•
- [ ] å›ºä»¶ä¸Šä¼ ç•Œé¢
- [ ] å›ºä»¶åˆ—è¡¨æ˜¾ç¤º
- [ ] ç‰ˆæœ¬ç®¡ç†æ“ä½œ
- [ ] è®¾å¤‡OTAè§¦å‘

### å›ºä»¶ç«¯æµ‹è¯•
- [ ] OTAç‰ˆæœ¬æ£€æŸ¥
- [ ] å›ºä»¶ä¸‹è½½ï¼ˆå°æ–‡ä»¶/å¤§æ–‡ä»¶ï¼‰
- [ ] è¿›åº¦æ˜¾ç¤º
- [ ] æ›´æ–°åé‡å¯
- [ ] å¤±è´¥å›æ»š

### é›†æˆæµ‹è¯•
- [ ] å®Œæ•´OTAæµç¨‹ï¼ˆä¸Šä¼ â†’æ£€æŸ¥â†’æ›´æ–°ï¼‰
- [ ] å¤šè®¾å¤‡åŒæ—¶æ›´æ–°
- [ ] ç½‘ç»œä¸­æ–­æ¢å¤
- [ ] ç‰ˆæœ¬å›é€€æµ‹è¯•

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. ä¿®å¤å›ºä»¶URLï¼ˆå¿…é¡»ï¼‰

```bash
# 1. ä¿®æ”¹ backend/app/core/config.py
# 2. æ·»åŠ  SERVER_BASE_URL é…ç½®
# 3. ä¿®æ”¹ backend/app/api/firmware.py ä½¿ç”¨é…ç½®
# 4. è®¾ç½®ç¯å¢ƒå˜é‡
export SERVER_BASE_URL=https://demo.example.com:8000
```

### 2. æµ‹è¯•å›ºä»¶ä¸Šä¼ 

```bash
# ä½¿ç”¨curlæµ‹è¯•
curl -X POST "http://localhost:8000/api/firmware/upload" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -F "file=@firmware.bin" \
  -F "product_code=ESP32-S3-Dev-01" \
  -F "version=1.5.0" \
  -F "description=æµ‹è¯•å›ºä»¶"
```

### 3. æµ‹è¯•OTAæ£€æŸ¥

```bash
# è®¾å¤‡ç«¯è°ƒç”¨
curl "http://provision.example.com/device/info?mac=AA:BB:CC:DD:EE:FF&firmware_version=1.4.0"
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [OTAè§£å†³æ–¹æ¡ˆæ–‡æ¡£](./OTA_SOLUTION.md)
- [å›ºä»¶ç«¯OTAé›†æˆæŒ‡å—](../firmware/aiot-esp32/OTA_INTEGRATION.md)
- [é…ç½®æœåŠ¡æ–‡æ¡£](../provisioning-service/QUICK_START.md)

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0.0  
**åˆ›å»ºæ—¶é—´**: 2025-11-20  
**ç»´æŠ¤è€…**: AIOTå›¢é˜Ÿ

