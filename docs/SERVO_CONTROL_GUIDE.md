# 180度舵机控制指南

## 概述

180度舵机（如SG90）通过PWM M2接口控制，使用PWM信号的占空比来控制舵机角度。

## 控制参数

### 1. PWM频率（Frequency）
- **标准值：50Hz**（周期20ms）
- 范围：1-40000 Hz
- **注意**：180度舵机必须使用50Hz频率

### 2. 占空比（Duty Cycle）
- 范围：0.0-100.0%
- 对应角度关系：

| 角度 | 脉宽 | 占空比 | 说明 |
|------|------|--------|------|
| 0° | 0.5ms | 2.5% | 最左位置 |
| 45° | 1.0ms | 5.0% | 中间偏左 |
| **90°** | **1.5ms** | **7.5%** | **中间位置** |
| 135° | 2.0ms | 10.0% | 中间偏右 |
| 180° | 2.5ms | 12.5% | 最右位置 |

## 控制命令格式

### 通过API控制

```json
{
  "cmd": "pwm",
  "channel": 2,
  "frequency": 50,
  "duty_cycle": 7.5
}
```

**参数说明**：
- `cmd`: 固定为 `"pwm"`
- `channel`: PWM通道，M2对应通道 `2`
- `frequency`: PWM频率，**180度舵机必须使用 `50` Hz**
- `duty_cycle`: 占空比（%），对应角度：
  - `2.5` = 0度
  - `7.5` = 90度（中间位置）
  - `12.5` = 180度

### 通过前端界面控制

1. 进入设备远程控制页面
2. 找到PWM M2控制卡片
3. **重要**：前端默认频率是5000Hz，需要手动修改为50Hz
4. 设置参数：
   - **频率**：**50 Hz**（必须手动设置，不要使用默认值5000Hz）
   - **占空比**：7.5%（对应90度）
5. 点击"应用PWM设置"按钮

**⚠️ 注意**：如果频率设置错误（如使用默认的5000Hz），舵机将无法正常工作！

## 角度计算公式

对于180度舵机，角度与占空比的换算公式：

```
占空比(%) = 2.5 + (角度 / 180) × 10
角度(度) = (占空比 - 2.5) × 18
```

**示例**：
- 转90度：`占空比 = 2.5 + (90/180) × 10 = 7.5%`
- 转45度：`占空比 = 2.5 + (45/180) × 10 = 5.0%`
- 转135度：`占空比 = 2.5 + (135/180) × 10 = 10.0%`

## 常用角度对照表

| 目标角度 | 占空比(%) | 说明 |
|---------|----------|------|
| 0° | 2.5 | 最左 |
| 30° | 4.17 | - |
| 45° | 5.0 | - |
| 60° | 5.83 | - |
| **90°** | **7.5** | **中间位置** |
| 120° | 9.17 | - |
| 135° | 10.0 | - |
| 150° | 10.83 | - |
| 180° | 12.5 | 最右 |

## 关于"正转"和"反转"

**重要说明**：标准180度舵机是**位置控制**，不是连续旋转。

- **"正转"**：从当前位置转到更大的角度（如：0° → 90° → 180°）
- **"反转"**：从当前位置转到更小的角度（如：180° → 90° → 0°）

**示例**：
- 当前在0度，要转到90度（正转）：
  ```json
  {
    "cmd": "pwm",
    "channel": 2,
    "frequency": 50,
    "duty_cycle": 7.5
  }
  ```

- 当前在180度，要转到90度（反转）：
  ```json
  {
    "cmd": "pwm",
    "channel": 2,
    "frequency": 50,
    "duty_cycle": 7.5
  }
  ```

**注意**：无论从哪个方向转到90度，占空比都是7.5%。舵机会自动选择最短路径转动。

## 360度连续旋转舵机控制

如果您使用的是**360度连续旋转舵机**，控制方式与180度舵机完全不同：

### 控制原理

360度连续旋转舵机通过PWM信号的占空比来控制旋转方向和速度：
- **停止**：占空比 7.5%（1.5ms脉宽，对应90度位置）
- **正转**：占空比 > 7.5%（如 8.0-12.5%），速度由占空比大小决定
- **反转**：占空比 < 7.5%（如 2.5-7.0%），速度由占空比大小决定

### 控制参数

**频率**：50Hz（与180度舵机相同）

**占空比范围**：
- 停止：7.5%
- 正转：8.0% - 12.5%（占空比越大，速度越快）
- 反转：2.5% - 7.0%（占空比越小，速度越快）

### 速度对照表

| 动作 | 占空比(%) | 速度 | 说明 |
|------|----------|------|------|
| 反转（最快） | 2.5 | 最快 | 最大反向速度 |
| 反转（快速） | 4.0 | 快 | - |
| 反转（中速） | 5.5 | 中 | - |
| 反转（慢速） | 7.0 | 慢 | 最小反向速度 |
| **停止** | **7.5** | **0** | **停止位置** |
| 正转（慢速） | 8.0 | 慢 | 最小正向速度 |
| 正转（中速） | 9.5 | 中 | - |
| 正转（快速） | 11.0 | 快 | - |
| 正转（最快） | 12.5 | 最快 | 最大正向速度 |

### 控制命令格式

#### 通过API控制

**停止**：
```json
{
  "cmd": "pwm",
  "channel": 2,
  "frequency": 50,
  "duty_cycle": 7.5
}
```

**正转（慢速）**：
```json
{
  "cmd": "pwm",
  "channel": 2,
  "frequency": 50,
  "duty_cycle": 8.0
}
```

**正转（快速）**：
```json
{
  "cmd": "pwm",
  "channel": 2,
  "frequency": 50,
  "duty_cycle": 12.0
}
```

**反转（慢速）**：
```json
{
  "cmd": "pwm",
  "channel": 2,
  "frequency": 50,
  "duty_cycle": 7.0
}
```

**反转（快速）**：
```json
{
  "cmd": "pwm",
  "channel": 2,
  "frequency": 50,
  "duty_cycle": 3.0
}
```

#### 通过前端界面控制

1. 进入设备远程控制页面
2. 找到PWM M2控制卡片
3. **重要**：前端默认频率是5000Hz，需要手动修改为50Hz
4. 设置参数：
   - **频率**：**50 Hz**（必须手动设置）
   - **占空比**：根据需要的动作设置
     - 停止：7.5%
     - 正转：8.0% - 12.5%（数值越大速度越快）
     - 反转：2.5% - 7.0%（数值越小速度越快）
5. 点击"应用PWM设置"按钮

### 速度调节技巧

1. **微调速度**：在停止位置（7.5%）附近微调占空比
   - 正转：从8.0%开始，逐步增加到12.5%找到合适速度
   - 反转：从7.0%开始，逐步减少到2.5%找到合适速度

2. **速度稳定性**：不同舵机对占空比的响应可能不同，需要实际测试

3. **停止精度**：7.5%是理论停止位置，实际可能需要微调（如7.4%或7.6%）

### 应用场景

- 机器人底盘驱动
- 传送带控制
- 旋转平台控制
- 其他需要连续旋转的应用

### 注意事项

1. **频率必须为50Hz**：与180度舵机相同
2. **占空比范围**：建议在2.5%-12.5%范围内，超出可能损坏舵机
3. **停止位置**：7.5%是理论停止位置，实际可能需要微调
4. **速度控制**：占空比与速度的关系不是线性的，需要实际测试
5. **供电**：连续旋转需要更多电流，确保电源供应充足

## 注意事项

1. **⚠️ 频率必须为50Hz**：
   - 180度舵机标准频率是50Hz（周期20ms）
   - 前端界面默认频率是5000Hz，**必须手动修改为50Hz**
   - 使用错误的频率（如5000Hz）会导致舵机完全不工作或损坏
   - 这是最常见的错误！请务必检查频率设置

2. **占空比范围**：通常2.5%-12.5%，超出范围可能导致舵机卡死或损坏

3. **供电**：确保舵机有足够的电源供应（通常需要5V，电流可能达到1A）

4. **信号线**：PWM M2对应GPIO40，确保连接正确

5. **设置顺序**：建议先设置频率（50Hz），再设置占空比（7.5%），最后点击应用

## 故障排查

1. **舵机不转动**（最常见问题）：
   - ✅ **首先检查频率是否为50Hz**（前端默认5000Hz是错误的！）
   - ✅ 检查占空比是否在2.5%-12.5%范围内
   - ✅ 检查是否点击了"应用PWM设置"按钮
   - ✅ 检查电源连接
   - ✅ 检查信号线连接（GPIO40）

2. **舵机抖动**：
   - 检查频率是否为50Hz（频率错误会导致抖动）
   - 检查电源是否稳定
   - 检查信号线连接是否良好

3. **角度不准确**：
   - 不同品牌舵机可能有微小差异，需要校准
   - 可以微调占空比来校准角度（±0.5%范围内微调）

4. **完全没反应**：
   - 99%的原因是频率设置错误（使用了默认的5000Hz而不是50Hz）
   - 检查前端界面显示的频率值
   - 重新设置为50Hz并应用

## 测试命令

### 测试90度位置

```bash
curl -X POST http://your-server/api/devices/{device_uuid}/control \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer {token}" \
  -d '{
    "cmd": "pwm",
    "channel": 2,
    "frequency": 50,
    "duty_cycle": 7.5
  }'
```

### 测试0度位置

```bash
curl -X POST http://your-server/api/devices/{device_uuid}/control \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer {token}" \
  -d '{
    "cmd": "pwm",
    "channel": 2,
    "frequency": 50,
    "duty_cycle": 2.5
  }'
```

### 测试180度位置

```bash
curl -X POST http://your-server/api/devices/{device_uuid}/control \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer {token}" \
  -d '{
    "cmd": "pwm",
    "channel": 2,
    "frequency": 50,
    "duty_cycle": 12.5
  }'
```

